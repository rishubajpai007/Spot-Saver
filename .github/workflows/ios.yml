name: iOS CI/CD

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-test-deploy:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    # 1. Setup Environment
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'

    # 2. Install Dependencies
    - name: Install Dependencies
      run: |
        gem install bundler
        gem install fastlane
        
        # Check if Podfile exists and install pods if needed
        if [ -f "Spot Saver/Podfile" ]; then 
            cd "Spot Saver" && pod install && cd ..
        fi

    # 3. RUN TESTS
    - name: Run Tests
      run: |
        xcodebuild \
        -project "Spot Saver/Spot Saver.xcodeproj" \
        -scheme "Spot Saver" \
        -destination 'platform=iOS Simulator,name=iPhone 16' \
        clean test

    # 4. DEPLOY TO TESTFLIGHT
    - name: Decode Secrets & Deploy
      if: github.ref == 'refs/heads/main'
      env:
        # --- File Secrets ---
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        WIDGET_PROVISION_PROFILE_BASE64: ${{ secrets.WIDGET_PROVISION_PROFILE_BASE64 }} # <--- NEW WIDGET SECRET
        
        # --- API Key Secrets ---
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      run: |
        # 1. Enter the Project Folder
        cd "Spot Saver"

        # 2. Decode Certificate
        echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode > build_certificate.p12
        
        # 3. Decode Main App Profile
        echo "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode > profile.mobileprovision
        
        # 4. Decode Widget Profile
        echo "$WIDGET_PROVISION_PROFILE_BASE64" | base64 --decode > widget_profile.mobileprovision
        
        # 5. Run Fastlane
        bundle exec fastlane beta
