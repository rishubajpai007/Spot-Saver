name: iOS CI/CD

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build-test-deploy:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    # 1. Setup Environment (Xcode + Ruby)
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable

    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.0'

    # 2. Install Dependencies (Fastlane + Pods)
    - name: Install Dependencies
      run: |
        gem install fastlane
        
        if [ -f "Spot Saver/Podfile" ]; then 
            cd "Spot Saver" && pod install && cd ..
        fi

    # 3. RUN TESTS (Validates code before deploying)
    - name: Run Tests
      run: |
        xcodebuild \
        -project "Spot Saver/Spot Saver.xcodeproj" \
        -scheme "Spot Saver" \
        -destination 'platform=iOS Simulator,name=iPhone 16' \
        clean test

    # 4. DEPLOY TO TESTFLIGHT (Only on 'main' branch)
    - name: Decode Secrets & Deploy
      if: github.ref == 'refs/heads/main'
      env:
        # Files (Base64)
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
        # API Keys & Passwords
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      run: |
        # 1. Decode the Base64 secrets into actual files
        echo "$BUILD_CERTIFICATE_BASE64" | base64 --decode > build_certificate.p12
        echo "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode > profile.mobileprovision
        
        # 2. Run Fastlane
        fastlane beta
